---
import { Image } from "astro:assets";
import { TIMETABLE_ROWS } from "@/data/timetable";
import SectionTitle from "@/components/SectionTitle.astro";
import ShixkuiBg from "@/components/ShixkuiBg.astro";
---

<section id="timetable" class="container">
  <ShixkuiBg />
  <div class="content">
    <SectionTitle
      en="Timetable"
      ja="当日のタイムテーブルをご紹介"
      sectionId="timetable"
    />
    <div class="tabs" role="tablist" aria-label="タイムテーブル表示切替">
      <button class="tab buttonBase isActive" role="tab" aria-selected="true">
        <span> SESSION ROOM</span>
      </button>
      <button class="tab buttonBase" role="tab" aria-selected="false"
        ><span>AMA ROOM</span></button
      >
    </div>

    <div class="tableWrapper">
      <table class="timetable" aria-label="タイムテーブル">
        <tbody class="tableBody">
          {
            TIMETABLE_ROWS.map((row) => {
              const isEvent = row.category === "event";

              return (
                <tr class="tableRow">
                  <th
                    scope="row"
                    class:list={[
                      "cell timeCell",
                      {
                        verticalMergeCell: !isEvent && row.list.length >= 2,
                      },
                    ]}
                  >
                    {isEvent ? (
                      <span class="timeText">{row.time}</span>
                    ) : (
                      <div class="timeRange">
                        <span class="timeText">{row.startAt}</span>
                        <span class="timeDivider" aria-hidden="true" />
                        <span class="timeText">{row.endAt}</span>
                      </div>
                    )}
                  </th>
                  {isEvent ? (
                    <td class="cell eventCell horizontalMergeCell">
                      {row.label}
                    </td>
                  ) : (
                    row.list.map((cell) => (
                      <td
                        class:list={[
                          "cell presentationCell",
                          {
                            horizontalMergeCell: row.list.length === 1,
                            shortTalk: !cell.isLongTalk,
                          },
                        ]}
                      >
                        <div class="cellBody">
                          <div class="cellContents">
                            <p
                              class:list={[
                                "cellTitle",
                                { emphasized: cell.isEmphasized },
                              ]}
                            >
                              {cell.title}
                            </p>
                            <div class="speakerInfo">
                              <span
                                class:list={[
                                  "speaker",
                                  { shortTalk: !cell.isLongTalk },
                                ]}
                              >
                                {cell.speakerName}
                              </span>
                              {cell.hasSlides && (
                                <a
                                  class="slide"
                                  href={cell.slidesUrl}
                                  target="_blank"
                                  rel="noreferrer"
                                >
                                  <span class="slidesText">登壇資料</span>
                                  <span
                                    class="externalLinkIcon"
                                    aria-hidden="true"
                                  >
                                    <svg
                                      width="12"
                                      height="12"
                                      viewBox="0 0 24 24"
                                      fill="none"
                                    >
                                      <path
                                        d="M14 3h7v7h-2V6.41l-9.29 9.3-1.42-1.42 9.3-9.29H14V3z"
                                        fill="currentColor"
                                      />
                                      <path
                                        d="M5 5h6v2H7v10h10v-4h2v6H5V5z"
                                        fill="currentColor"
                                      />
                                    </svg>
                                  </span>
                                </a>
                              )}
                            </div>
                          </div>
                          <Image
                            src={cell.thumbnailImage}
                            class:list={[
                              "speakerIcon",
                              { shortTalk: !cell.isLongTalk },
                            ]}
                            width={cell.isLongTalk ? 108 : 80}
                            height={cell.isLongTalk ? 108 : 80}
                            alt={cell.speakerName}
                            data-astro-image="constrained"
                          />
                        </div>
                      </td>
                    ))
                  )}
                </tr>
              );
            })
          }
        </tbody>
      </table>
    </div>
  </div>
</section>

<style>
  @import "../css/utils.css";
  @import "../css/vars.css";

  .container {
    position: relative;
    overflow: hidden;
  }

  .container::before {
    position: absolute;
    top: -61vw;
    left: 50%;
    z-index: var(--intro-decoration-z-index);
    width: 150vw;
    height: 70vw;
    content: "";
    background: var(--bg-light);
    border-radius: 0 0 50% 50%;
    box-shadow: 0px 8px 64px 0px rgba(0, 0, 0, 0.16);
    transform: translateX(-50%);
  }

  .content {
    display: flex;
    flex-direction: column;
    align-self: stretch;
    max-width: 992px;
    padding: 14vw 16px 0;
    margin: 0 auto;
    isolation: isolate;
    backdrop-filter: blur(0px);
  }

  .tabs {
    display: flex;
    align-items: stretch;
    width: 100%;
    padding: 8px 10px;
    margin-top: 24px;
    background: rgba(255, 255, 255, 0.08);
    border-radius: 9999px;
    backdrop-filter: blur(16px);
  }

  .tab {
    position: relative;
    width: 50%;
    padding: 12px 20px;
    overflow: hidden;
    font-size: 24px;
    font-weight: 700;
    line-height: 1;
    color: #ffffff;
    text-transform: uppercase;
    letter-spacing: 0.02em;
    appearance: none;
    cursor: pointer;
    background: none;
    border: 0;
    border-radius: 100vh;
  }
  .tab.isActive::before,
  .tab.isActive::after,
  .tab.isActive span::before,
  .tab.isActive span::after {
    position: absolute;
    inset: 0;
    z-index: -1;
    content: "";
    border-radius: inherit;
  }
  .tab.isActive::before {
    background: var(--grad-color-1);
    mix-blend-mode: var(--grad-blend-mode-1);
  }
  .tab.isActive span::before {
    background: var(--grad-color-2);
    mix-blend-mode: var(--grad-blend-mode-2);
  }
  .tab.isActive span::after {
    background: var(--grad-color-3);
    mix-blend-mode: var(--grad-blend-mode-3);
  }
  .tab.isActive::after {
    background: var(--grad-color-4);
    mix-blend-mode: var(--grad-blend-mode-4);
  }

  .tab:not(.isActive) {
    text-shadow: 0 4px 4px rgba(0, 0, 0, 0.25);
  }

  .tableWrapper {
    align-self: stretch;
    padding: 16px;
    margin-top: 16px;
    overflow-x: auto;
    background: rgba(255, 255, 255, 0.08);
    border-radius: 12px;
  }

  .timetable {
    display: grid;
    grid-template-columns: 120px 1fr 1fr;
    gap: 8px;
    width: 100%;
    border-spacing: 8px 8px;
    border-collapse: separate;

    thead,
    tbody,
    tfoot,
    tr {
      display: contents;
    }
  }

  .horizontalMergeCell {
    grid-column: auto / span 2;
  }

  .timeCell {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 21.5px 24px;
  }
  .eventCell {
    padding: 24px;
  }
  .presentationCell {
    padding: 26px 24px;
  }
  .presentationCell.shortTalk {
    padding: 20px 24px;
  }

  .timeRange {
    display: grid;
    grid-auto-flow: row;
    gap: 8px;
    align-items: center;
    justify-items: center;
    width: 120px;
  }

  .timeText {
    font-size: 24px;
    font-weight: 700;
    line-height: 1;
    color: #ffffff;
    text-align: center;
  }

  .timeDivider {
    width: 2px;
    height: 13px;
    background: #ffffff;
  }

  .cell {
    vertical-align: top;
    text-align: center;
    background: var(--bg-dark);
    border-radius: 8px;
  }

  .cellBody {
    display: flex;
    gap: 16px;
    align-items: center;
  }

  .cellContents {
    display: flex;
    flex-grow: 1;
    flex-direction: column;
    gap: 12px;
    align-items: flex-start;
  }

  .cellTitle {
    display: -webkit-box;
    flex: 1;
    max-height: calc(1.5em * 3);
    overflow: hidden;
    -webkit-line-clamp: 3;
    line-height: 1.3;
    color: #ffffff;
    letter-spacing: 0.02em;
    -webkit-box-orient: vertical;
  }

  .emphasized {
    font-size: 20px;
  }

  .speakerInfo {
    display: flex;
    align-items: center;
    justify-content: space-between;
    width: 100%;
  }

  .speakerIcon {
    border-radius: 12px;
  }

  .speaker {
    font-family: var(--font-noto-sans-jp);
    font-size: 16px;
    font-weight: 500;
    line-height: 1.4;
    color: #ffffff;
    letter-spacing: 0.02em;
  }
  .speaker.shortTalk {
    font-size: 12px;
  }

  .slide {
    color: #fff;
    text-decoration: none;
  }
  .slidesText {
    font-size: 12px;
    font-weight: 500;
    line-height: 1.4;
    letter-spacing: 0.02em;
  }

  @media (--breakpoint-sp) {
    .container {
      padding: 60px 0;
    }
    .container::before {
      top: -20vw;
      height: 40vw;
    }
    .content {
      padding-top: 27vw;
    }

    .tabs {
      width: 100%;
      margin-top: 48px;
    }
    .tab {
      padding: 12px 18px;
      font-size: 22px;
    }

    .timetable {
      grid-template-columns: 80px 1fr;
      row-gap: 4px;
    }
    .cell {
      padding: 16px;
    }
    .eventCell {
      padding: 24px;
      line-height: 1.35;
    }
    .presentationCell {
      padding: 16px;
    }
    .colTime {
      width: 140px;
    }
    .cellBody {
      flex-direction: column;
      align-items: unset;
    }
    .cellContents {
      gap: 8px;
    }
    .timeText {
      font-size: 20px;
    }
    .cellTitle,
    .speaker,
    .slidesText {
      font-size: clamp(12px, 3vw, 16px);
    }

    .horizontalMergeCell {
      grid-column: auto;
    }
    .verticalMergeCell {
      grid-row: auto / span 2;
    }
    .speakerIcon {
      width: 116px;
      height: 116px;
    }
    .speakerIcon.shortTalk {
      width: 80px;
      height: 80px;
    }
  }
</style>

<script>
  // ROOMの表示切り替えは一旦classの付け替えで対応
  // キーボード操作によるタブ切り替えは未対応
  const tabsContainer = document.querySelector(
    '[role="tablist"]',
  ) as HTMLElement;
  const tabs = tabsContainer?.querySelectorAll(
    '[role="tab"]',
  ) as NodeListOf<HTMLButtonElement>;

  if (tabsContainer && tabs) {
    tabs.forEach((tab, index) => {
      if (index === 0) {
        tab.setAttribute("tabindex", "0");
      } else {
        tab.setAttribute("tabindex", "-1");
      }
    });

    tabs.forEach((tab) => {
      tab.addEventListener("click", () => {
        tabs.forEach((otherTab) => {
          otherTab.classList.remove("isActive");
          otherTab.setAttribute("aria-selected", "false");
          otherTab.setAttribute("tabindex", "-1");
        });

        tab.classList.add("isActive");
        tab.setAttribute("aria-selected", "true");
        tab.setAttribute("tabindex", "0");
      });
    });
  }
</script>
